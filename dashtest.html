<!DOCTYPE html>
<!--Start of HTML-->
<html>
  <head>
    <link rel="stylesheet" href="style.css">
    <title>Dash.js Video Player</title>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  </head>
  <body>
    <div id="title">
      <span style = "text-decoration: underline; font-weight: bold; font-size: x-large;">Concordia DASH.js simulation</span>
      <span>by Antonio Reda and Hamna Akhter</span>
    </div>

    <!--adds video element-->
    <video id="videoPlayer" controls></video>
    <!--adds button elements-->
    <div id="buttons">
      <button onclick="DisableABR()">Low Quality</button>
      <button onclick="EnableABR()">High Quality</button>
      <button onclick="enableDynamicABR()">Enable Dynamic ABR</button>
      <button onclick="enableBOLATABR()">Enable BOLA ABR</button>
      <button onclick="enableThroughputABR()">Enable Throughput ABR</button>
    </div>

    <div id="data">
      <div id="staple">
        <strong>Buffer level:</strong>
        <span id="bufferLevel">0</span> seconds
      </div>

      <div id="staple">
        <strong>Throughput:</strong>
        <span id="throughput">0</span> kbps
      </div>

      <div id="staple">
        <strong>Bitrate:</strong>
        <span id="bitrate">0</span> kbps
      </div>      
      <div id="staple">
        <strong>Download Time:</strong>
        <span id="downloadTime">0</span> kbps
      </div>

      <div id="staple">
        <strong>Size:</strong>
        <span id="size">0</span> kbps
      </div>
    </div>
<!--End of HTML-->

<!--Begining of JS-->
    <script>
        //initialize 3 important variables to play the video.
         var video = document.querySelector('video');
         var player = dashjs.MediaPlayer().create();
         var url = "https://nustreaming.github.io/streaming/bbb.mpd";

        //initialize 3 important variables for keeping track of metadata.
        var bufferLevelElement = document.getElementById('bufferLevel');
        var throughputElement = document.getElementById('throughput');
        var bitrateElement = document.getElementById('bitrate');

      function DisableABR()
        {
            //turns off ABR
            player.updateSettings({'streaming': {'abr': {'useDefaultABRRules': false}}});
            //relaunches the player.
            player.initialize(document.querySelector("video"), url, true);
        };
        function EnableABR()
        {
            //turns on ABR
            player.updateSettings({'streaming': {'abr': {'useDefaultABRRules': true}}});
            //relaunches the player.
            player.initialize(document.querySelector("video"), url, true);
        };
        function enableDynamicABR() {
            // Set ABR to dynamic: A dynamic algorithm that is based on buffer occupancy and current network throughput. It is the default ABR strategy in dash.js.
            player.updateSettings({'streaming': {'abr': {'ABRStrategy': 'dynamic'}}});
            //relaunches the player.
            player.initialize(document.querySelector("video"), url, true);
            //double checking abr strategy in console, can delete later
            console.log("ABR strategy: " + player.getSettings().streaming.abr.ABRStrategy);
        }
        function enableBOLATABR() {
            // Set ABR to BOLA: A bitrate selection algorithm that uses a moving window of throughput estimates to select the optimal bitrate for playback.
            player.updateSettings({'streaming': {'abr': {'ABRStrategy': 'bola'}}});
            //relaunches the player.
            player.initialize(document.querySelector("video"), url, true);
            //double checking abr strategy in console, can delete later
            console.log("ABR strategy: " + player.getSettings().streaming.abr.ABRStrategy);
        }
        function enableThroughputABR() {
            // Set ABR to throughput-based:  A simple algorithm that selects the bitrate based on the current network throughput.
            player.updateSettings({'streaming': {'abr': {'ABRStrategy': 'throughput'}}});
            //relaunches the player.
            player.initialize(document.querySelector("video"), url, true);
            //double checking abr strategy in console, can delete later
            console.log("ABR strategy: " + player.getSettings().streaming.abr.ABRStrategy);
        }

        setInterval(function() {
        var bufferLevel = player.getBufferLength('video');
        bufferLevelElement.innerHTML = bufferLevel.toFixed(2);
        console.log(bufferLevel);

        var throughput = player.getAverageThroughput('video');
        throughputElement.innerHTML = (throughput / 1000).toFixed(2);
        console.log(throughput);

        var bitrate = player.getQualityFor('video');
        bitrateElement.innerHTML = (bitrate).toFixed(5);
        console.log(bitrate);
       
       
        // var downloadTime = player.getDashMetrics().getCurrentHttpRequest('video', true).tresponse.getTime() - player.getDashMetrics().getCurrentHttpRequest('video', true).trequest.getTime();
        // downloadTimeElement.innerHTML = downloadTime.toFixed(2);
        // console.log(downloadTime);

        // var size = player.getDashMetrics().getCurrentHttpRequest('video', true).responsePayloadSize * 8 / downloadTime / 1000;
        // sizeElement.innerHTML = size.toFixed(2);
        // console.log(size);

        // var dashMetrics = player.getDashMetrics();
        // var videoRequest = dashMetrics.getHttpRequests('video')[0];
        // if (videoRequest) {
        //   var downloadTime = videoRequest._tfinish.getTime() - videoRequest.tresponse.getTime();
        //   var size = videoRequest._size;
        //   downloadTimeElement.innerHTML = downloadTime.toFixed(2);
        //   sizeElement.innerHTML = (size / 1000).toFixed(2);
        // }

      }, 8000);
    </script>
<!--End of JS-->


  </body>
</html>
